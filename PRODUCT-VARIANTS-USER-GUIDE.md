# 📘 راهنمای استفاده از سیستم Product Attributes & Variants

> **تاریخ:** 20 نوامبر 2025  
> **نسخه:** 1.0

---

## 🎯 فلوی کامل استفاده از سیستم

### مرحله 1️⃣: ورود به سیستم و ایجاد Business

```
1. باز کردن اپلیکیشن
2. ثبت‌نام یا ورود
3. ایجاد Business (فروشگاه/شرکت)
4. ورود به Dashboard
```

---

### مرحله 2️⃣: دسترسی به مدیریت ویژگی‌ها

#### 🔹 از کجا وارد شوم؟

```
Dashboard → محصولات → آیکون تنظیمات (⚙️ Tune Icon) در AppBar
```

**یا مستقیماً:**
```
http://localhost:port/#/attributes?businessId=YOUR_BUSINESS_ID
```

#### 🔹 چه چیزی می‌بینم؟

صفحه **مدیریت ویژگی‌های محصولات** با:
- لیست تمام ویژگی‌های تعریف شده
- دکمه "+ ویژگی جدید"
- جستجو و فیلتر براساس:
  - Scope: ثابت / متغیر
  - DataType: متن، عدد، انتخابی، رنگ و ...
  - وضعیت: فعال / غیرفعال

---

### مرحله 3️⃣: تعریف ویژگی‌ها (Attributes)

#### مثال 1: ویژگی "سایز" (متغیر)

```
نام: سایز
کد: size (یونیک - فقط حروف انگلیسی و -)
نوع داده: انتخابی (SELECT)
تک/چند داده‌ای: تک مقداره (SINGLE)
سطح: ویژگی متغیر (VARIANT_LEVEL)
مقادیر ممکن: S, M, L, XL, XXL
اجباری: ✅ بله
فعال: ✅ بله
```

#### مثال 2: ویژگی "رنگ" (متغیر)

```
نام: رنگ
کد: color
نوع داده: رنگ (COLOR)
تک/چند داده‌ای: تک مقداره
سطح: ویژگی متغیر (VARIANT_LEVEL)
اجباری: ✅ بله
فعال: ✅ بله
```

#### مثال 3: ویژگی "جنس" (ثابت)

```
نام: جنس
کد: material
نوع داده: انتخابی (SELECT)
تک/چند داده‌ای: چند مقداره (MULTIPLE) ← می‌تواند هم پنبه هم پلی‌استر باشد
سطح: ویژگی ثابت (PRODUCT_LEVEL) ← برای همه Variantها یکسان
مقادیر ممکن: پنبه, پلی‌استر, کتان, ابریشم
اجباری: ⬜ خیر
فعال: ✅ بله
```

---

### مرحله 4️⃣: ایجاد محصول با Variants

#### A) ایجاد محصول:

```
Dashboard → محصولات → دکمه "+" (افزودن محصول)

اطلاعات پایه:
├─ نام: تی‌شرت مردانه
├─ کد: TSH-001
├─ قیمت پایه: 150,000 ریال (برای محاسبه Variantها)
├─ واحد: عدد
└─ وضعیت: فعال

⚠️ نکته مهم: در تب "تنوع محصول"
├─ Toggle "این محصول دارای تنوع است" را فعال کنید ✅
└─ سایز و رنگ را از لیست انتخاب کنید
```

#### B) تب "تنوع محصول" (Product Variants Tab):

در این تب می‌بینید:
```
☑️ این محصول دارای تنوع است

ویژگی‌های ثابت (برای همه یکسان):
[ ] جنس → انتخاب: پنبه

ویژگی‌های متغیر (در هر تنوع متفاوت):
[x] سایز
[x] رنگ

📦 تنوع‌ها: (0 مورد)
[+ افزودن تنوع] [مدیریت کامل]
```

---

### مرحله 5️⃣: ایجاد Variants (تنوع‌ها)

#### راه A: از داخل فرم محصول

```
تب "تنوع محصول" → دکمه "+ افزودن تنوع"

فرم باز می‌شود:
┌─────────────────────────────────────┐
│ افزودن تنوع جدید                   │
├─────────────────────────────────────┤
│ اطلاعات پایه:                       │
│ • SKU: TSH-001-L-BLUE (خودکار)    │
│ • نام: تی‌شرت مردانه L آبی         │
│                                     │
│ ویژگی‌ها:                           │
│ • سایز: [انتخاب] → L               │
│ • رنگ: [انتخاب رنگ] → آبی          │
│                                     │
│ موجودی:                             │
│ • موجودی فعلی: 10                  │
│ • حداقل موجودی: 2                  │
│ • نقطه سفارش: 5                    │
│                                     │
│ قیمت‌گذاری:                         │
│ ( ) تفاوت قیمت: 0                  │
│ (•) قیمت مطلق: 150,000             │
│                                     │
│ [لغو]            [ذخیره تنوع] ✅   │
└─────────────────────────────────────┘
```

#### راه B: مدیریت کامل Variants

```
تب "تنوع محصول" → دکمه "مدیریت کامل"

یا مستقیماً:
Dashboard → محصولات → کلیک روی محصول → "مدیریت تنوع‌ها"
```

صفحه **مدیریت تنوع‌های محصول** باز می‌شود:
```
┌──────────────────────────────────────────┐
│ تنوع‌های محصول: تی‌شرت مردانه           │
├──────────────────────────────────────────┤
│ [+ تنوع جدید]  [حذف انتخاب شده]        │
│                                          │
│ فیلترها:                                 │
│ وضعیت: [همه ▼] | موجودی کم: [ ]         │
│ جستجو: [____________________] 🔍        │
│                                          │
│ ┌────────────────────────────────────┐   │
│ │ [ ] TSH-001-S-RED                  │   │
│ │     سایز: S | رنگ: 🔴 قرمز        │   │
│ │     موجودی: 8 | قیمت: 145,000     │   │
│ │     [ویرایش] [حذف]                 │   │
│ └────────────────────────────────────┘   │
│                                          │
│ ┌────────────────────────────────────┐   │
│ │ [ ] TSH-001-M-BLUE                 │   │
│ │     سایز: M | رنگ: 🔵 آبی         │   │
│ │     موجودی: 12 | قیمت: 150,000    │   │
│ │     [ویرایش] [حذف]                 │   │
│ └────────────────────────────────────┘   │
│                                          │
│ ┌────────────────────────────────────┐   │
│ │ [ ] TSH-001-L-BLUE                 │   │
│ │     سایز: L | رنگ: 🔵 آبی         │   │
│ │     موجودی: 3 ⚠️ (موجودی کم!)    │   │
│ │     قیمت: 160,000                  │   │
│ │     [ویرایش] [حذف]                 │   │
│ └────────────────────────────────────┘   │
└──────────────────────────────────────────┘
```

---

### مرحله 6️⃣: فروش (Invoice) با Variant

```
Dashboard → فاکتورها → فاکتور جدید

1. انتخاب مشتری
2. افزودن کالا → انتخاب "تی‌شرت مردانه"
3. اگر محصول Variant دارد، Bottom Sheet باز می‌شود:

┌─────────────────────────────────────┐
│ انتخاب تنوع محصول                  │
├─────────────────────────────────────┤
│ [ فقط موجود ]                       │
│                                     │
│ ┌─────────────────────────────────┐ │
│ │ TSH-001-S-RED                   │ │
│ │ سایز: S | رنگ: 🔴              │ │
│ │ موجودی: 8 | قیمت: 145,000      │ │
│ │            [انتخاب] ✅          │ │
│ └─────────────────────────────────┘ │
│                                     │
│ ┌─────────────────────────────────┐ │
│ │ TSH-001-M-BLUE                  │ │
│ │ سایز: M | رنگ: 🔵              │ │
│ │ موجودی: 12 | قیمت: 150,000     │ │
│ │            [انتخاب] ✅          │ │
│ └─────────────────────────────────┘ │
│                                     │
│ ┌─────────────────────────────────┐ │
│ │ TSH-001-L-BLUE                  │ │
│ │ سایز: L | رنگ: 🔵              │ │
│ │ موجودی: 3 ⚠️ | قیمت: 160,000  │ │
│ │            [انتخاب] ✅          │ │
│ └─────────────────────────────────┘ │
└─────────────────────────────────────┘

4. انتخاب Variant مورد نظر (مثلاً L-BLUE)
5. وارد کردن تعداد: 2
6. کالا به فاکتور اضافه می‌شود

✅ پس از ثبت فاکتور:
├─ از موجودی Variant L-BLUE کسر می‌شود: 3 - 2 = 1
├─ اگر موجودی به زیر minStock برسد → وضعیت: موجودی کم ⚠️
└─ تاریخچه در StockTransaction ذخیره می‌شود
```

---

### مرحله 7️⃣: گزارش موجودی

```
Dashboard → محصولات → آیکون نمودار (📊) در AppBar
```

یا:
```
http://localhost:port/#/stock-report?businessId=YOUR_BUSINESS_ID
```

#### صفحه گزارش موجودی:

```
┌────────────────────────────────────────┐
│ گزارش موجودی                           │
├────────────────────────────────────────┤
│ [Tab: لیست] | [Tab: نمودار]            │
│                                        │
│ 📊 خلاصه:                              │
│ ┌─────┐ ┌─────┐ ┌─────┐                │
│ │ 25  │ │  5  │ │  2  │                │
│ │کل   │ │موجودی│ │ناموجود│            │
│ │تنوع │ │ کم  │ │     │                │
│ └─────┘ └─────┘ └─────┘                │
│                                        │
│ جستجو: [_________________] 🔍          │
│ فیلتر وضعیت: [همه ▼]                  │
│ مرتب‌سازی: [موجودی (کم به زیاد) ▼]   │
│                                        │
│ ┌──────────────────────────────────┐   │
│ │ 🔴 TSH-001-L-BLUE                │   │
│ │    موجودی: 1 (حداقل: 2) ⚠️      │   │
│ │    قیمت: 160,000 | ارزش: 160k   │   │
│ └──────────────────────────────────┘   │
│                                        │
│ ┌──────────────────────────────────┐   │
│ │ 🟢 TSH-001-M-BLUE                │   │
│ │    موجودی: 12                    │   │
│ │    قیمت: 150,000 | ارزش: 1.8M   │   │
│ └──────────────────────────────────┘   │
└────────────────────────────────────────┘

[Tab: نمودار]
├─ Pie Chart: توزیع وضعیت (موجود، کم، ناموجود)
├─ Bar Chart: 10 Variant با بیشترین موجودی
└─ [دکمه Export به Excel] 📥
```

---

## 🗺️ نقشه کامل Navigation

```
Dashboard
│
├─ 📦 محصولات (/products)
│  │
│  ├─ AppBar Actions:
│  │  ├─ 📊 گزارش موجودی → /stock-report
│  │  ├─ ⚙️ مدیریت ویژگی‌ها → /attributes
│  │  └─ 📁 دسته‌بندی‌ها → /categories
│  │
│  ├─ + محصول جدید (/product/create)
│  │  └─ Tab "تنوع محصول"
│  │     ├─ + افزودن تنوع → VariantFormDialog
│  │     └─ مدیریت کامل → /variants
│  │
│  └─ کلیک روی محصول (/product/:id)
│     └─ مدیریت تنوع‌ها → /variants
│
├─ ⚙️ مدیریت ویژگی‌ها (/attributes)
│  ├─ + ویژگی جدید → AttributeFormPage
│  └─ کلیک روی ویژگی → ویرایش
│
├─ 🎯 مدیریت تنوع‌های محصول (/variants?productId=X)
│  ├─ + تنوع جدید → VariantFormDialog
│  ├─ ویرایش → VariantFormDialog
│  └─ حذف
│
└─ 📊 گزارش موجودی (/stock-report)
   ├─ Tab: لیست تنوع‌ها
   ├─ Tab: نمودارها
   └─ Export Excel (آینده)
```

---

## 🎨 UI Components جدید

### 1️⃣ VariantFormDialog
- فرم کامل ایجاد/ویرایش Variant
- 6 بخش: Basic Info, Attributes, Stock, Pricing, Dimensions, Notes
- ورودی دینامیک براساس نوع attribute
- Color picker برای رنگ‌ها

### 2️⃣ VariantSelector (BottomSheet)
- انتخاب Variant در فاکتور
- فیلتر براساس موجودی
- نمایش SKU, attributes, قیمت, موجودی

### 3️⃣ ProductVariantsTab
- Tab در فرم محصول
- Toggle فعال/غیرفعال variants
- لیست مینی (5 تا اول)
- دکمه "مدیریت کامل"

### 4️⃣ AttributesManagementPage
- لیست attributes با فیلتر
- افزودن/ویرایش/حذف
- Badge های رنگی براساس type

### 5️⃣ VariantsManagementPage
- مدیریت کامل تمام variants یک محصول
- جستجو و فیلتر
- ویرایش دسته‌جمعی

### 6️⃣ StockReportScreen
- گزارش موجودی با نمودار
- فیلترها و مرتب‌سازی
- Export (آینده)

---

## 🔧 Backend Setup (یادآوری)

### دیتابیس:
```sql
-- جداول موجود:
✅ product_attribute           (ویژگی‌ها)
✅ product_attribute_value     (مقادیر ثابت محصول)
✅ product_variant             (تنوع‌ها)
✅ stock_transaction           (تاریخچه موجودی)
✅ invoice_item (updated)      (+ variantId, variantSnapshot)
```

### API Endpoints:

```
Attributes:
POST   /api/product/attributes
GET    /api/product/attributes?businessId=X
PUT    /api/product/attributes/:id
DELETE /api/product/attributes/:id

Variants:
POST   /api/product/:productId/variants
GET    /api/product/:productId/variants
PUT    /api/product/variants/:id
DELETE /api/product/variants/:id
GET    /api/product/variants/low-stock?businessId=X

Stock:
PATCH  /api/product/variants/:id/stock
GET    /api/product/:productId/inventory
```

---

## ✅ چک‌لیست استفاده

- [ ] Backend اجرا شد و جداول ساخته شدند
- [ ] Flutter اجرا شد
- [ ] یک Business ایجاد کردم
- [ ] وارد صفحه محصولات شدم
- [ ] آیکون ⚙️ (Tune) را در AppBar می‌بینم → مدیریت ویژگی‌ها
- [ ] آیکون 📊 (Bar Chart) را در AppBar می‌بینم → گزارش موجودی
- [ ] آیکون 📁 (Category) را در AppBar می‌بینم → دسته‌بندی
- [ ] وارد مدیریت ویژگی‌ها شدم و 3 ویژگی ساختم (سایز، رنگ، جنس)
- [ ] یک محصول با Variants ساختم
- [ ] تنوع‌ها را مدیریت کردم
- [ ] در فاکتور، Variant را انتخاب کردم
- [ ] گزارش موجودی را مشاهده کردم

---

## 🆘 مشکلات رایج

**1. آیکون‌ها را نمی‌بینم:**
- مطمئن شوید که فایل `products_page.dart` آپدیت شده
- Hot Restart کنید (R + R در terminal)

**2. صفحه Attributes باز نمی‌شود:**
- چک کنید route در `main.dart` اضافه شده
- URL صحیح: `/attributes?businessId=YOUR_ID`

**3. Variant ذخیره نمی‌شود:**
- Backend اجرا است؟
- Database اطلاعات دارد؟
- Console errors چک کنید

**4. در Invoice، Variant انتخاب نمی‌شود:**
- محصول `hasVariants = true` است؟
- Variant حداقل یکی ساخته شده؟
- موجودی > 0 است؟

---

## 📝 نکات مهم

1. **Variants فقط برای محصولات با `hasVariants = true` فعال است**
2. **موجودی در سطح Variant مدیریت می‌شود نه محصول**
3. **هر Variant باید SKU یونیک داشته باشد**
4. **Attributes قبل از ایجاد محصول باید تعریف شوند**
5. **Snapshot در Invoice تاریخچه Variant را حفظ می‌کند**

---

🎉 **حالا آماده استفاده هستید!**
